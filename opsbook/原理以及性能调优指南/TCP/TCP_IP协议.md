# TCP IP协议详解
---

## 分层
自下而上: 链路层, 网络层, 传输层, 应用层

封装:
当应用程序使用TCP传输数据时, 数据被协议送入协议栈中,然后逐个通过每一层知道当做一床比特流送入网络. 其中每一层都会加入一些首部信息(有时需要加入尾部信息), 该过程.

TCP传给IP的数据单元乘坐TCP报文段或者简称TCP段(TCP segment).
IP传给网络层的数据单元叫做IP数据报(IP datagram)
通过以太网传输的比特流叫做帧(Frame)

以太网数据帧的物理特性是长度需要在46-1500字节之间

UDP数据与TCP数据基本一致. 唯一不同的是UDP传给IP的信息称作UDP数据报(UDP Datagram), 且UDP的首部长度为8个字节.

## 数据链路层
链路层的目的:
1. 为IP模块发送和接收数据报
2. 为ARP模块发送ARP请求和接收ARP请求.
3. 为RARP发送RARP请求和接收ARAP应答.

### 以太网
以太网（英语：Ethernet）是一种计算机局域网技术。IEEE组织的IEEE 802.3标准制定了以太网的技术标准，它规定了包括物理层的连线、电子信号和介质访问层协议的内容。以太网是目前应用最普遍的局域网技术，替换了其他局域网标准如令牌环、FDDI和ARCNET。
以太网的标准拓扑结构为总线型拓扑，但目前的快速以太网（100BASE-T、1000BASE-T标准）为了减少冲突，将能提高的网络速度和使用效率最大化，使用交换机（Switch hub）来进行网络连接和组织。如此一来，以太网的拓扑结构就成了星型；但在逻辑上，以太网仍然使用总线型拓扑和CSMA/CD（Carrier Sense Multiple Access/Collision Detection，即载波多重访问/碰撞侦测）的总线技术。

### CSMA/CD

1. 开始 - 如果线路空闲，则启动传输，否则跳转到第4步。
2. 发送 - 如果检测到冲突，继续发送数据直到达到最小回报时间（min echo receive interval）以确保所有其他转发器和终端检测到冲突，而后跳转到第4步。
3. 成功传输 - 向更高层的网络协议报告发送成功，退出传输模式。
4. 线路繁忙 - 持续等待直到线路空闲。
5. 线路空闲 - 在尚未达到最大尝试次数之前，每隔一段随机时间转到第1步重新尝试。
6. 超过最大尝试传输次数 - 向更高层的网络协议报告发送失败，退出传输模式。

### frame 的格式(以太网封装RFC 894)

!(../../../images/lianluceng.png)[shuju连]

CRC字段用于帧内后续字节的差错的循环冗余码检测(校验和).

> 802.3标准顶一顶帧和以太网帧都有最小长度要求. 802.3规定数据部分至少为38个字节, 而对于以太网,则要求最少有46字节. 为了保证这一点, 必须在不足的空间插入填充(pad)字节.

### 最大传输单元MTU
以太网和802.3对数据的长度都一个限制, 其最大值分贝时1500和1492字节. 链路层的这个特征称作MTU, 最大传输单元. 

#### 路径MTU
传输路径中 最小的那个MTU称作路径MTU

Linux中查看MTU; ifconfig
netstat -in

## IP: 网际协议

### IP的数据包格式

!(../../../iamges/IPv4格式.png)[ddd]

从上图, 最高位在左边, 记为0bit; 最低位在右边, 记为31bit.

`网络字节序`: 4个字节的32位bit值以下的次序传输: 首先0-7bit, 其次8-15bit, 然后16-23bit, 最后24-31bit. 这种传输次序争做big edian字节序. 由于TCP/IP首部中所有的2进制证书在网络传输时都要求以这种顺序传输, 因此他又称做网络字节序. 以及其他存储形式的二进制整数的机器, 如little endian格式, 则必须传输数据之前把首部转换成网络字节序.


IP首部长度指的是首部占据的32位bit的数目, 包括任何选项. 由于它是一个自比特的字段, 因此首部最长为60字节.

`服务类型(TOS)`包括一个3bit的优先权字段(现在已被忽略), 4bit的TOS子字段和1bit未用位必须置为0.  4bit的TOS分别表示: 最小时延, 最大吞吐量, 最高可靠性和最小费用. 4bit中只能置其中1bit. 如果所有4bit均为0, 那么意味着是一般服务.

`总长度字段`指的是整个IP数据报的长度, 单位为字节. 利用首部长度字段和总长度字段, 就可以知道IP数据报中数据内容的起始位置和长度.  因为这个16位, 所以IP数据报的最大为65525. 
总长度字段在IP首部是必须的, 因为一些数据链路需要填充一些数据达到最小长度.

`标识字段`: 唯一表示主机发送的每一份数据报. 通常每发一份数据报他的值就会加1.

`TTL(time-to-live)`: 生存时间字段设置数据报可以经过最多的路由器数. 他指定了数据报的生存时间. TTL的初始值由源主机设置(通常是为32 或者64), 一旦经过处理他的路由器她的值会减1. 当该字段为0时, 数据报就会被丢弃, 并发送ICMP报文通知源主机.

首部校验和字段是IP首部计算的检验和码. 他不对首部后面的数据进行计算.

### IP的路由选择

### 子网寻址
